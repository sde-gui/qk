/*
 *   tests/medit.c.in
 *
 *   Copyright (C) 2004-2005 by Yevgen Muntyan <muntyan@math.tamu.edu>
 *
 *   This program is free software; you can redistribute it and/or modify
 *   it under the terms of the GNU General Public License as published by
 *   the Free Software Foundation; either version 2 of the License, or
 *   (at your option) any later version.
 *
 *   See COPYING file that comes with this distribution.
 */

#include "mooui/moouiobject.h"
#include "mooedit/mooeditor.h"
#include "mooedit/mooeditplugin.h"
#include "mooedit/moofileview/moofileview.h"
#include "editor-ui.h"


static void init_actions (void);
static void ref_types (void);

int main (int argc, char **argv)
{
    char *rcfile, *plugin_dir;
    MooEditor *editor;
    MooEditLangMgr *mgr;
    MooEditWindow *win;
    MooUIXML *xml;

    gtk_init (&argc, &argv);

    init_actions ();
    ref_types ();

    rcfile = g_build_filename (g_get_home_dir (), ".meditrc", NULL);
    moo_prefs_load (rcfile);

    plugin_dir = g_build_filename (g_get_home_dir (), ".medit", "plugins", NULL);
    moo_edit_plugin_read_dir ("@MOO_EDIT_PLUGINS_DIR@");
    moo_edit_plugin_read_dir (plugin_dir);
    g_free (plugin_dir);

    editor = moo_editor_new ();
    mgr = moo_editor_get_lang_mgr (editor);
    moo_edit_lang_mgr_add_lang_files_dir (mgr, "/usr/share/gtksourceview-1.0/language-specs");
    moo_edit_lang_mgr_add_lang_files_dir (mgr, "@MOO_EDIT_LANG_FILES_DIR@");

    g_signal_connect (editor, "all-windows-closed", G_CALLBACK (gtk_main_quit), NULL);

    xml = moo_editor_get_ui_xml (editor);
    if (!moo_ui_xml_add_ui_from_string (xml, MEDIT_UI, -1, NULL))
        g_error ("%s", G_STRLOC);

    win = moo_editor_new_window (editor);

    if (argc > 1)
        moo_editor_open_file (editor, win, NULL,
                              argv[1], NULL);

    gtk_main ();

    moo_prefs_save (rcfile);

    g_object_unref (editor);
    g_free (rcfile);

    return 0;
}


static void show_preferences (MooEditWindow *window)
{
    GtkWidget *dialog = moo_prefs_dialog_new ("Preferences");
    moo_edit_plugin_attach_prefs (MOO_PREFS_DIALOG (dialog));
    moo_prefs_dialog_run (MOO_PREFS_DIALOG (dialog), GTK_WIDGET (window));
}


static void init_prefs_action (GObjectClass *klass)
{
    moo_ui_object_class_new_action (klass,
                                    "id", "Preferences",
                                    "name", "Preferences",
                                    "label", "Preferences",
                                    "tooltip", "Preferences",
                                    "icon-stock-id", GTK_STOCK_PREFERENCES,
                                    "closure::callback", show_preferences,
                                    NULL);
}


static void init_actions (void)
{
    GObjectClass *klass = g_type_class_ref (MOO_TYPE_EDIT_WINDOW);

    g_return_if_fail (klass != NULL);

    moo_ui_object_class_new_action (klass,
                                    "id", "SendToTerminal",
                                    "dead", TRUE,
                                    NULL);
    moo_ui_object_class_new_action (klass,
                                    "id", "Terminal",
                                    "dead", TRUE,
                                    NULL);
    moo_ui_object_class_new_action (klass,
                                    "id", "PythonMenu",
                                    "dead", TRUE,
                                    NULL);
    moo_ui_object_class_new_action (klass,
                                    "id", "About",
                                    "dead", TRUE,
                                    NULL);
    moo_ui_object_class_new_action (klass,
                                    "id", "Quit",
                                    "dead", TRUE,
                                    NULL);
    init_prefs_action (klass);

    g_type_class_unref (klass);
}


static void ref_types (void)
{
    volatile GType type;
    type = MOO_TYPE_FILE_VIEW;
}
